---
title: "Raport"
author: "Michał Łochowski, Paweł Górdak, Dawid Drawc"
date: "`r format(Sys.Date(), '%d.%m.%Y')`"
output:
  rmdformats::downcute:
    self_contained: true
    thumbnails: true
    lightbox: true
    gallery: false
    highlight: zenburn
    css: "custom.css"
---

# Wprowadzenie

## Cel Raportu

Celem tego raportu jest analiza zbioru danych **apartaments_pl_2024_06**.  
Aby to osiągnąć, dane zostaną oczyszczone, brakujące wartości uzupełnione, a następnie przeprowadzona zostanie analiza opisowa oraz wnioskowanie statystyczne wraz z wizualizacją wyników.  

## Przegląd zbioru danych  

Zbiór danych **apartaments_pl_2024_06** zawiera informacje o rynku nieruchomości w największych miastach Polski.  
Koncentruje się na cenach nieruchomości, wielkości mieszkań, bliskości infrastruktury miejskiej oraz roku budowy.  

## Zmienne w zbiorze danych aparaments_pl_2024_06  

Zbiór danych zawiera następujące zmienne:  

#### Zmienne opisujące lokalizację mieszkania:  

**id** – Unikalny identyfikator każdej nieruchomości generowany komputerowo  

**city** – Miasto, w którym znajduje się nieruchomość  

**latitude** – Szerokość geograficzna  

**longitude** – Długość geograficzna  

#### Zmienne opisujące cenę i status własności nieruchomości:  

**price** – Cena nieruchomości  

**ownership** – Status własności nieruchomości  

#### Zmienne opisujące typ i wielkość mieszkania:  

**type** – Typ budynku: blok mieszkalny, apartamentowiec, kamienica  

**buildingMaterial** – Materiał użyty do budowy budynku  

**condition** – Aktualny stan nieruchomości  

**squareMeters** – Całkowita powierzchnia nieruchomości (w metrach kwadratowych)  

**rooms** – Liczba pokoi w nieruchomości  

**floor** – Piętro, na którym znajduje się nieruchomość  

**floor count** – Całkowita liczba pięter w budynku  

#### Zmienne opisujące odległość od kluczowych udogodnień w mieście:  

**centreDistance** – Odległość od centrum miasta  

**poiCount** – Liczba punktów użyteczności publicznej w pobliżu nieruchomości  

**schoolDistance** – Odległość do najbliższej szkoły  

**clinicDistance** – Odległość do najbliższej przychodni medycznej  

**postOfficeDistance** – Odległość do najbliższej poczty  

**kindergartenDistance** – Odległość do najbliższego przedszkola  

**restaurantDistance** – Odległość do najbliższej restauracji  

**collegeDistance** – Odległość do najbliższego college’u/uniwersytetu  

**pharmacyDistance** – Odległość do najbliższej apteki  

#### Zmienne opisujące, czy nieruchomość lub budynek, w którym się znajduje, obejmuje określoną infrastrukturę:  

**hasParkingSpace** – Czy nieruchomość posiada miejsce parkingowe (Tak/Nie)  

**hasBalcony** – Czy nieruchomość posiada balkon (Tak/Nie)  

**hasElevator** – Czy budynek posiada windę (Tak/Nie)  

**hasSecurity** – Czy nieruchomość/budynek posiada zabezpieczenia (Tak/Nie)  

**hasStorageRoom** – Czy nieruchomość posiada pomieszczenie gospodarcze (Tak/Nie)  

## Czyszczenie i przetwarzanie danych  

#### Installation of needed libraries and data

```{r setup1, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
options(repos = c(CRAN = "https://cran.rstudio.com"))
options(qwraps2_markup = "markdown")

library(e1071)
if (!require("naniar")) install.packages("naniar")  
library(naniar)    
if (!require("VIM")) install.packages("VIM")
library(VIM)
if (!require("mice")) install.packages("mice")
library(mice)
library(haven)
library(frequency)
library(corrplot)
library(ggpubr) 
library(ggplot2)
library(scales)
library(dplyr) 
library(knitr)
library(corrplot) 
library(moments)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(kableExtra)
install.packages("validate")
library(validate)
if (!require("qwraps2")) install.packages("qwraps2")
library(qwraps2)
if (!require("DMwR2")) install.packages("DMwR2")
library(DMwR2)
if (!require("outliers")) install.packages("outliers")
library(outliers)
if (!require("arsenal")) install.packages("arsenal")
library(arsenal)
if (!require("papeR")) install.packages("papeR")
library(papeR)
if (!require("summarytools")) install.packages("summarytools")
library(summarytools)
if (!require("classInt")) install.packages("classInt")
library(classInt)
if (!require("pastecs")) install.packages("pastecs")
library(pastecs)
if (!require("desctable")) install.packages("desctable")
library(desctable)
if (!require("frequency")) install.packages("frequency")
library(frequency)
if (!require("psych")) install.packages("psych")
library(psych)
if (!require("ggstatsplot")) install.packages("ggstatsplot")
library(ggstatsplot)

#data reading
apartments <- read_csv("apartments_pl_2024_06.csv")

```

#### Visualizing the missing data using missing-data map

```{r visualize-missing-data, echo=TRUE, message=FALSE, warning=FALSE}
# Missing Data Map
vis_miss(apartments)

# UpSet plot for missing data
library(naniar)
gg_miss_upset(apartments, nsets = 3)
```

Otrzymany wykres pokazuje, że brakujące dane w zbiorze stanowią około 6,3% wszystkich danych. Większość brakujących wartości pochodzi z zmiennej condition, której braki wynoszą 74%, oraz **material**, gdzie braki sięgają 41%. Znaczące deficyty danych można również zauważyć w zmiennych: **type**, **floor** oraz **buildYear**, które zawierają odpowiednio 20%, 17% i 16% brakujących wartości.

Brakujące dane w zbiorze mogą wynikać z kilku czynników. Wysoki odsetek brakujących wartości w zmiennych condition i buildingMaterial sugeruje, że takie informacje często nie są ujawniane przez właścicieli nieruchomości lub w ogłoszeniach na portalach. Podobnie, luki w zmiennych **type**, **floor** i **buildYear** mogą wynikać z niekompletnych zapisów dotyczących starszych nieruchomości lub niespójności w sposobie raportowania danych w różnych miastach. W niektórych przypadkach szczegóły dotyczące nieruchomości mogą być celowo pomijane przez sprzedających, aby zwiększyć atrakcyjność ogłoszenia lub z powodu braku dokładnych informacji.


```{r, echo=TRUE, message=FALSE, warning=FALSE}
str(apartments)

numeric_cols <- apartments %>% select(where(is.numeric))

find_outliers_iqr <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  return(which(x < lower_bound | x > upper_bound))
}

outliers_iqr <- lapply(numeric_cols, find_outliers_iqr)
```
```{r}
# Wybór tylko zmiennych numerycznych
numeric_cols <- apartments %>% select(where(is.numeric))

# Funkcja do wykrywania wartości odstających metodą IQR
find_outliers_iqr <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  return(which(x < lower_bound | x > upper_bound))  # Zwraca indeksy wartości odstających
}

# Znalezienie wartości odstających dla wszystkich zmiennych numerycznych
outliers_iqr <- lapply(numeric_cols, find_outliers_iqr)

# Wizualizacja wartości odstających za pomocą boxplotów dla każdej zmiennej numerycznej
par(mfrow = c(3, 3))  # Układ wykresów (3x3)
for (col in colnames(numeric_cols)) {
  boxplot(numeric_cols[[col]], main = col, col = "turquoise", border = "navy", outline = TRUE)
}
par(mfrow = c(1, 1))  # Powrót do domyślnego układu wykresów
```
W Wyniku analizy zbioru danych, możemy zobaczyć, że dane apartments_pl_2024_06 zawierają wiele wartości odstających. Wartości odstające, możemy zaobserwować dla niemal wszystkich zmiennych. Szczególnymi przykładami może być zmienne: Price, collegeDistance oraz Centre Distance.

### Zastępowanie wartości odstających medianą

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Lista zmiennych związanych z odległościami (distance)
distance_vars <- c("centreDistance", "schoolDistance", "clinicDistance", 
                   "postOfficeDistance", "kindergartenDistance", 
                   "restaurantDistance", "collegeDistance", "pharmacyDistance")

# Funkcja do zastępowania wartości odstających medianą (dla zmiennych numerycznych poza distance_vars)
replace_outliers_with_median <- function(x) {
  Q1 <- quantile(x, 0.25, na.rm = TRUE)
  Q3 <- quantile(x, 0.75, na.rm = TRUE)
  IQR <- Q3 - Q1
  lower_bound <- Q1 - 1.5 * IQR
  upper_bound <- Q3 + 1.5 * IQR
  
  # Zastąp wartości odstające medianą
  x[x < lower_bound | x > upper_bound] <- median(x, na.rm = TRUE)
  return(x)
}

# Tworzenie nowego zbioru danych apartments2
apartments2 <- apartments

# Przetwarzanie zmiennych numerycznych z wyłączeniem distance_vars
for (col in names(numeric_cols)) {
  if (!(col %in% distance_vars)) {
    apartments2[[col]] <- replace_outliers_with_median(apartments[[col]])
  }
}

# Sprawdzenie pierwszych kilku wierszy w nowym zbiorze danych
head(apartments2)

# Porównanie statystyk przed i po przetwarzaniu
cat("Statystyki dla pierwotnego zbioru danych:\n")
summary(apartments)

cat("\nStatystyki dla przetworzonego zbioru danych (apartments2):\n")
summary(apartments2)
```

#### Wypełnianie brakujących danych używając funkcji hotdeck

```{r, echo=TRUE, message=FALSE, warning=FALSE}
 czyste <- hotdeck(apartments2)

n_miss(czyste)  # Licznik wartości NA
n_complete(czyste)  # Licznik prawidłowych wartości
pct_miss(czyste)  # Procentowa ilość wartości NA w zbiorze danych

```

##Rdzeń analizy

Kluczową zmienną do analizy w zbiorze danych jest cena, ponieważ opisuje ona sytuację na polskim rynku mieszkaniowym, na którym oparty jest ten zbiór danych.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
descriptive_stats <- czyste %>%
  select(price) %>%
  summarise(
    Mean = format(mean(price, na.rm = TRUE), big.mark = ".", scientific = FALSE, digits = 0),
    Median = format(median(price, na.rm = TRUE), big.mark = ".", scientific = FALSE, digits = 0),
    Std_Dev = format(sd(price, na.rm = TRUE), big.mark = ".", scientific = FALSE, digits = 0),
    Min = format(min(price, na.rm = TRUE), big.mark = ".", scientific = FALSE, digits = 0),
    Max = format(max(price, na.rm = TRUE), big.mark = ".", scientific = FALSE, digits = 0),
  
  )

# Print the results
print(descriptive_stats)
skew_value <- skewness(czyste$price, na.rm = TRUE)
kurt_value <- kurtosis(czyste$price, na.rm = TRUE)

print(paste("Skewness: ", skew_value))
print(paste("Kurtosis: ", kurt_value))
```

Po odrzuceniu danych odstających otrzymany rozkład dla zmiennej price jest względnie równy. Skośność na poziomie 0,69 wskazuje na rozkład lekko prawostronnie skośny tzw. "Dłuższy ogon po prawej stronie".

```{r, echo=TRUE, message=FALSE, warning=FALSE}
install.packages("psych")
library(psych)
raport <-
  list("Cena w PLN" =
       list("Min"= ~ min(price),
            "Max"= ~ max(price),
            "Kwartyl dolny"= ~ quantile(price,0.25),
            "Mediana"= ~ round(median(price),0),
            "Kwartyl górny"= ~ quantile(price,0.75),
            "Średnia"= ~ round(mean(price),0),
            "Odch. std."= ~ round(sd(price),0),
            "Odstęp Międzykwartyllowy"= ~ round(iqr(price),0),
            "Odchylenie ćwiartkowe"=~round(iqr(price)/2,0),
            "Odch. std. w %"=~round((sd(price)/mean(price)),4),
            "Odch. ćwiartkowe w %"=~round((iqr(price)/median(price)),4),
            "Skośność"=~round(skew(price),4),
            "Kurtoza"=~round(kurtosi(price),4)
            ))
tabela<-summary_table(czyste, summaries = raport, by = c("rooms"))

knitr::kable(tabela,
  digits = 2,
  align = "lcccc",
  caption="Tabela cen mieszkań w Polskich miastach - ceny w PLN wg liczby pokoi.",
  col.names = c("Statystyka","1 pokój", "2 pokoje", "3 pokoje", "4 pokoje")) 
```
##### Min i Max
Najtańsze mieszkanie w oczyszczonej serii danych kosztuje 191.000 PLN najdroższe zaś 1.588.000. Najtańsze mieszkania dla wszystkich liczb pokoi kosztują poniżej 300.000 PLN. W przypadku najdroższych mieszkań jedynie w przypadku mieszkań 1 pokojowych cenna jest mniejsza od 1.000.000 PLN.
Największa różnica pomiędzy najdroższym a najtańszym mieszkaniem występuję w przypadku mieszkań 2 pokojowych i wynosi 1.394.000 PLN jednak różnica dla mieszkań 3 i 4 pokojowych nie dużo mniejsza  i wynosi odpowiednio 1.340.000 PLN oraz 1.289.000 PLN. Najmniejsza zaś różnica jest w przypadku mieszkań 1 pokojowych i wynosi 779.000 PLN. Jednak są to wartości nominalne nie uwzględniające tego jak duże są pokoje. Poniższa tabela przedstawia metraż jaki mają badane przez nas skrajne obserwacje wraz z ceną za m^2.


```{r, echo=TRUE, message=FALSE, warning=FALSE}
skrajne_mieszkania <- czyste %>%
  group_by(rooms) %>%
  filter(price == min(price) | price == max(price)) %>%
  group_by(rooms, price) %>%
  filter(ifelse(price == min(price), squareMeters == min(squareMeters), squareMeters == max(squareMeters))) %>%
  ungroup() %>%
  mutate(price_per_m2 = round(price / squareMeters, 2)) %>%  
  select(rooms, price, squareMeters, price_per_m2) %>%
  arrange(rooms, price)

knitr::kable(skrajne_mieszkania, 
             digits = 2, 
             align = "lccc",
             caption = "Tabela skrajnych mieszkań - ceny, metraż i koszt za m²",
             col.names = c("Liczba pokoi", "Cena (PLN)", "Powierzchnia (m²)", "Cena za m² (PLN)"))
```
Mimo że największa dysproporcja w cenie była obserwowalna dla mieszkań z dwoma pokojami to największa różnica w cenie za m^2 jest widoczna w przypadku mieszkań z 3 pokojami i wynosi 24675,96 PLN dla wartości skrajnych, gdzie pozycją o drugiej największej różnicy są miezkania z 1 pokojem 21211,40 PLN


##### Średnia i Mediana
Średnia cena mieszkań dla mieszkań o 2; 3 i 4 pokojach jest większa od mediany co sugeruje rozkład cen skośny prawostornnie oznaczao to, że mieszkania drogie znacznie wpływają na średnią.

Na Potrzeby dalszej analizy dodajmy zmienną priceSquareMeter oznaczającą cenę za m^2 dla danego mieszkania.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
czyste <- czyste %>%
  mutate(priceSquareMeter = round(price / squareMeters, 2))
```

#### Aby przeanalizować stan polskiego rynku mieszkaniowego, apartamenty zostały pogrupowane w przedziały cenowe:

```{r, echo=TRUE, message=FALSE, warning=FALSE}
limits <- c(0, 250000, 500000, 750000, 1000000, 1250000, Inf)

labels <- c("<250,000 PLN", "250,000 - 499,999 PLN", "500,000 - 749,999 PLN", 
  "750,000 - 999,999 PLN", "1,000,000 - 1,249,999 PLN", "≥1,250,000 PLN")

czyste$price_category <- cut(
  czyste$price, 
  breaks = limits, 
  labels = labels, 
  include.lowest = TRUE, 
  right = FALSE
)

for (i in 1:length(labels)) {
  czyste[paste0("in_range_", i)] <- ifelse(czyste$price_category == labels[i], 1, 0)
}

price_counts <- czyste %>%
  count(price_category) %>%
  mutate(percentage = n / sum(n) * 100)  

fixed_label_height <- max(price_counts$n) * 1.05  # Slightly above max count for visibility
ggplot(price_counts, aes(x = price_category, y = n, fill = price_category)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            vjust = 2, 
            size = 5, 
            color = "black",
            nudge_y = fixed_label_height - max(price_counts$n)) +  
  scale_y_continuous(labels = scales::comma) +  
  theme_minimal() +
  labs(
    title = "Rozkład cen apartamentów",
    x = "Przedział cenowy",
    y = "Liczba apartamentów"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

```

Wizualizacja pokazuje, w jakich przedziałach cenowych znajdują się apartamenty w zbiorze danych. Największy klaster apartamentów znajduje się w przedziale cenowym od 500 000 do 749 999 PLN, który obejmuje 40,2% obserwacji. Kolejne dwie kategorie z największą liczbą obserwacji to 750 000 do 999 999 PLN (24,7%) oraz 250 000 do 499 999 PLN (18,5%). Łącznie stanowią one 83,4% obserwacji.

##### Orginalne dane zawierały skrajne ceny mieszkań, poniższa tabela przedstawia dystrybucję orginalnych danych dla przyjętych pułapów cenowych.
```{r, echo=TRUE, message=FALSE, warning=FALSE}
limits <- c(0, 250000, 500000, 750000, 1000000, 1250000, Inf)

apartments$price_category <- cut(apartments$price, breaks = limits, labels = labels, include.lowest = TRUE, right = FALSE)

price_counts <- apartments %>%
  count(price_category) %>%
  mutate(percentage = round(n / sum(n) * 100, 1))  

knitr::kable(price_counts, 
             digits = 1, 
             align = "lc", 
             caption = "Tabela rozkładu cen mieszkań przed odrzuceniem wartości skrajnych",
             col.names = c("Przedział cenowy", "Liczba mieszkań", "Procentowy udział (%)"))
```

Po odrzuceniu wartości odstających mieszkania o cenie wyższej niż 1.250.000 PLN stanowią 6,9% badanych mieszkań jednak uwzględniając wartości odstające mieszkania o cenie wyższej niż 1.250.000 PLN stanowiły 13,2%


```{r, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(czyste, aes(x = city, y = priceSquareMeter)) +  
  geom_boxplot(aes(fill = city), alpha = 0.85) +  
  theme_minimal() +  
  labs(title = "Rozkład cen według miasta", x = NULL, y = "Cena za metr kwadratowy") +   
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +  
  scale_y_continuous(labels = scales::label_number(big.mark = ".", decimal.mark = ","))  
ggplot(czyste, aes(x = city, y = squareMeters)) +  
  geom_boxplot(aes(fill = city), alpha = 0.85) +  
  theme_minimal() +  
  labs(title = "Rozkład metrażu mieszkań według miasta", x = NULL, y = "Metraż") +   
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank()) +  
  scale_y_continuous(labels = scales::label_number(big.mark = ".", decimal.mark = ",")) 
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Zlicz wystąpienia i oblicz procentowy udział dla zmiennej 'ownership'
ownership_counts <- czyste %>%
  count(ownership) %>%
  mutate(percentage = n / sum(n) * 100)  # Convert counts to percentages

# Ustal stałą wysokość etykiet (dostosuj w zależności od zbioru danych)
fixed_label_height <- max(ownership_counts$n) * 1.05  # Slightly above max count for visibility

# Wizualizuj rozkład własności ('ownership')
ggplot(ownership_counts, aes(x = ownership, y = n, fill = ownership)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            vjust = 2, 
            size = 5, 
            color = "black",
            nudge_y = fixed_label_height - max(ownership_counts$n)) +  # Fixed height
  scale_y_continuous(labels = scales::comma) +  # Format Y-axis with thousands separator
  theme_minimal() +
  labs(
    title = "Distribution of Ownership",
    x = "Ownership",
    y = "Count of Apartments"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  # Rotate labels for readability

```

89,7% Własność kondominium: Dominacja kondominiów sugeruje, że większość osób w zbiorze danych posiada swoje mieszkania jako indywidualne jednostki z osobistym tytułem własności. Jest to zgodne z bardziej rynkowym modelem mieszkalnictwa, w którym podkreśla się prywatną własność, a właściciele mają pełną kontrolę nad swoimi lokalami.

10,3% Własność spółdzielcza: Mniejszy odsetek osób mieszka w lokalach spółdzielczych, co wskazuje, że choć nadal istotna, ta forma własności jest mniej powszechna. Własność spółdzielcza jest często bardziej regulowana i może ograniczać pewne swobody, takie jak możliwość swobodnej sprzedaży lub wynajmu lokalu.

Blisko 0% Własność udziałowa: Znikoma obecność opcji „udział” sugeruje, że ta forma własności jest rzadka lub może zanikać na polskim rynku mieszkaniowym. Może to wskazywać na odchodzenie od starszych, zbiorowych struktur własnościowych.

### Analiza mapy cieplnej

```{r, echo=TRUE, message=FALSE, warning=FALSE}
# Compute correlation matrix for selected variables
correlation_matrix <- cor(czyste %>% select(price, poiCount, squareMeters, rooms), 
                          use = "pairwise.complete.obs")

# Plot correlation heatmap for key apartment features
corrplot(correlation_matrix, method = "square", 
         tl.cex = 0.8, cl.cex = 0.8, 
         type = "upper", order = "hclust", 
         addCoef.col = "black", number.cex = 0.7,
         title = "Correlation Heatmap for Selected Variables", mar = c(0, 0, 2, 0)) 

# Define relevant POI variables
poi_vars <- c("schoolDistance", "clinicDistance", "postOfficeDistance", 
              "kindergartenDistance", "restaurantDistance", "collegeDistance", 
              "pharmacyDistance", "centreDistance", "price")

# Ensure all selected variables exist in the dataset
existing_poi_vars <- poi_vars[poi_vars %in% colnames(czyste)]

# Compute correlation matrix for POI distances and price
poi_correlation <- cor(czyste %>% select(all_of(existing_poi_vars)), 
                       use = "pairwise.complete.obs")

# Plot POI correlation heatmap
corrplot(poi_correlation, method = "square", 
         tl.cex = 0.8, cl.cex = 0.8, 
         type = "upper", order = "hclust", 
         addCoef.col = "black", number.cex = 0.7,
         title = "POI Distance Correlations with Price", mar = c(0, 0, 2, 0)) 

# Define correlation analysis function
correlation_analysis <- function(data) {
  required_columns <- c("price", "poiCount", "squareMeters", "rooms")
  
  # Ensure required columns exist
  existing_columns <- required_columns[required_columns %in% names(data)]
  
  if (length(existing_columns) < length(required_columns)) {
    stop("One or more required columns are missing from the dataset.")
  }
  
  # Compute correlation values
  cor_matrix <- cor(data[, existing_columns], use = "pairwise.complete.obs")
  
  # Create correlation heatmap
  corrplot(cor_matrix, 
           method = "color", 
           col = colorRampPalette(c("orange", "white", "navy"))(200), 
           type = "upper", 
           order = "hclust", 
           addCoef.col = "black", 
           tl.col = "black", 
           tl.srt = 45, 
           title = "Correlation Heatmap")
}

# Execute correlation analysis
correlation_analysis(czyste)

```

Analiza mapy cieplnej korelacji między różnymi zmiennymi prowadzi do trzech wykresów:

Pierwszy wykres przedstawia korelację między wybranymi zmiennymi, takimi jak szerokość geograficzna, cena, metraż, liczba pokoi, piętro, liczba pięter w budynku, długość geograficzna, rok budowy oraz odległość od centrum. Wykazuje on niewielką lub żadną korelację między większością z tych zmiennych.

Druga mapa cieplna przedstawia korelację między mieszkaniem a odległością do różnych udogodnień. Pokazuje ona, że zazwyczaj, jeśli mieszkanie znajduje się blisko jednej infrastruktury, to jest także blisko innej. Co jednak ciekawe, istnieje negatywna korelacja między ceną a odległością do kliniki oraz restauracji, co wskazuje, że im mniejsza odległość, tym wyższa cena mieszkania. Jest to szczególnie nietypowe w kontekście pozytywnej korelacji między ceną a odległością do centrum, co sugeruje, że im bliżej centrum znajduje się mieszkanie, tym jest tańsze. Wynik ten stoi w sprzeczności z intuicyjną hipotezą, że mieszkania w centrum miasta są najdroższe. Może to oznaczać, że w danych znajduje się znaczna liczba mieszkań na przedmieściach, które są warte więcej niż mieszkania w obszarach miejskich.

Trzeci wykres przedstawia mapę cieplną mierzącą cenę w odniesieniu do liczby pokoi oraz powierzchni mieszkania. Naturalna hipoteza, że większe mieszkania i większa liczba pokoi oznaczają wyższą cenę, znajduje potwierdzenie, wykazując bardzo wysoką dodatnią korelację.

Następnie tworzony jest wykres analizujący wpływ piętra, na którym znajduje się mieszkanie, na jego cenę.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
ggplot(czyste, aes(x = floor)) +
  geom_histogram(binwidth = 1, fill = "blue", alpha = 0.7) +
  theme_minimal() +
  scale_x_continuous(breaks = seq(min(czyste$floor, na.rm = TRUE), 
                                  max(czyste$floor, na.rm = TRUE), 
                                  by = 1)) 
  labs(title = "Distribution of Apartments by Floor", x = "Floor", y = "Count")



```

Wykres pokazuje, że większość mieszkań znajduje się na niższych piętrach oraz że ogólnie liczba budynków mających mniej niż 5 pięter jest większa, co sugeruje, że większość budynków jest raczej niewielka.

##### Analizę pięter można lepiej zrozumieć poprzez analizę typów budynków w badanej populacji.

```{r , echo=TRUE, message=FALSE, warning=FALSE}
# Calculate the count and percentage of each building type
type_summary <- czyste %>%
  count(type) %>%
  mutate(percentage = n / sum(n) * 100)

# Create a bar plot to show the count and percentage of each building type with fixed bar height
ggplot(type_summary, aes(x = type, y = n)) +
  geom_bar(stat = "identity", fill = "steelblue", color = "black", width = 0.7) +
  geom_text(aes(label = paste0(round(percentage, 1), "%")), 
            vjust = 0.5, hjust = 0.5, size = 5, color = "black") +  # Center the percentage
  theme_minimal() +
  labs(title = "Distribution of Building Types", x = "Building Type", y = "Count") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) 

# Calculate the average price for each building type
average_price_by_type <- czyste %>%
  group_by(type) %>%
  summarise(avg_price = mean(price, na.rm = TRUE))


```

Bloki mieszkalne dominują w 62,5%, budynki mieszkalne stanowią 20,2%, a kamienice 17,3%. Znaczna liczba kamienic, które zazwyczaj są małe i niezbyt wysokie, w dużym stopniu przyczynia się do tego, że apartamenty w populacji znajdują się zazwyczaj na niższych piętrach.


```{r}
ggplot(czyste, aes(x = buildingMaterial, y = price, fill = buildingMaterial)) +
  geom_boxplot(alpha = 0.8) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Impact of Building Material on Price", x = "Building Material", y = "Price") 

#Impact of Security on Apartment Prices
ggplot(czyste, aes(x = factor(hasSecurity, labels = c("No Security", "Has Security")), y = price)) +
  geom_boxplot(aes(fill = factor(hasSecurity)), alpha = 0.8) +
  theme_minimal() +
  labs(title = "Impact of Security on Apartment Prices", x = "Security", y = "Price") +
  scale_fill_manual(values = c("red", "green"))


```

Dane pokazują, że ogólnie apartamenty zbudowane z cegły są droższe niż te wykonane z betonu, a apartamenty z ochroną są droższe niż te bez ochrony. Jednak w obu przypadkach istnieje wiele odstających wartości w populacji, co oznacza, że nie ma silnej korelacji między tymi dwoma czynnikami. Ważne dla analizy jest jednak to, że gęstość odstających wartości dla apartamentów bez ochrony sugeruje, że istnieją bardzo drogie apartamenty, które nie mają ochrony.




## Wnioskowanie Statystyczne

```{r}
if (!require(nortest)) install.packages("nortest")
library(nortest)
# Test Andersona-Darlinga
ad_test <- ad.test(czyste$price)

# Histogram z gęstością rozkładu
ggplot(czyste, aes(x = price)) +
  geom_histogram(aes(y = ..density..), bins = 50, fill = "skyblue", color = "black", alpha = 0.7) +
  geom_density(color = "red", linewidth = 1) +
  labs(title = "Histogram cen mieszkań z gęstością", x = "Cena", y = "Gęstość") +
  theme_minimal()

# QQ-plot
ggplot(data.frame(price = czyste$price), aes(sample = price)) +
  stat_qq(distribution = qnorm) +
  stat_qq_line(distribution = qnorm, color = "red", linewidth = 1) +
  labs(title = "QQ-plot dla cen mieszkań", x = "Kwantyle teoretyczne", y = "Kwantyle empiryczne") +
  theme_minimal()

# Empiryczna funkcja rozkładu vs. normalna
ggplot(data.frame(price = sort(czyste$price)), aes(x = price)) +
  stat_ecdf(geom = "step", color = "blue", linewidth = 1) +
  stat_function(fun = function(x) pnorm(x, mean = mean(czyste$price), sd = sd(czyste$price)), 
                color = "red", linetype = "dashed", linewidth = 1) +
  labs(title = "Empiryczna CDF vs. Normalna CDF", x = "Cena", y = "Prawdopodobieństwo") +
  theme_minimal()
```


------------------------------------------------------------------------

## Wyniki
##### Dane ogólne
Analiza polskiego rynku nieruchomości na podstawie danych z czerwca 2024 roku pokazuje, że większość polskich apartamentów, bo 77,1%, mieści się w przedziale cenowym od 250 000 do 1 000 000 PLN. Rozkład cen jest wyraźnie przesunięty w prawo, co wskazuje na dużą liczbę apartamentów o wysokiej cenie. Ponad 13% nieruchomości przekracza cenę 1 250 000 PLN, co potwierdza obecność nieruchomości luksusowych.

##### Miasto, w którym znajduje się apartament, jest najważniejszym czynnikiem wpływającym na jego cenę
Wykresy pudełkowe pokazują znaczną zmienność cen między miastami. Stan apartamentu nie wpływa silnie na cenę, co pokazuje wykres skrzypcowy. Analiza ANOVA ceny według miasta i stanu potwierdza, że różnice cenowe zależą bardziej od miasta niż od stanu technicznego apartamentu.

##### Odległość od miasta
Negatywna korelacja między ceną a odległością od klinik/restauracji sugeruje, że apartamenty o wysokiej wartości znajdują się w rejonach o lepszej infrastrukturze miejskiej. Nieoczekiwany wynik: Apartamenty oddalone od centrum są droższe, co może wynikać z obecności luksusowych nieruchomości podmiejskich w zamkniętych osiedlach. Zbiór danych może być zniekształcony przez luksusowe inwestycje podmiejskie, a nie tradycyjne miejskie apartamenty.

### Ostateczne wnioski
Polski rynek nieruchomości zdominowany jest przez apartamenty w średnim przedziale cenowym (500 000 - 999 999 PLN). W rynku luksusowym występują wartości odstające, które znacząco wpływają na miary statystyczne. Przewagę ma własność prywatna (prawie 90%), a spółdzielcze mieszkania stanowią niewielki odsetek. Stan apartamentu ma niewielki wpływ na cenę, co sugeruje, że bardziej liczy się lokalizacja. Bliskość do klinik i restauracji ma pozytywny związek z ceną, podczas gdy odległość od centrum miasta wykazuje nieoczekiwaną negatywną korelację. Nieoczekiwany efekt odległości od centrum sugeruje, że drogie nieruchomości mogą być skoncentrowane w podmiejskich, luksusowych inwestycjach, a nie w tradycyjnych centrach miast.

## Źródła
```{r}
citation("ggstatsplot")
  
```
